<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delulu Diaries âœ¨</title>
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ff69b4">
    
    <!-- Styles -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" style="
        position: fixed; 
        top: 0; left: 0; 
        width: 100%; height: 100%; 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        z-index: 9999;
        color: white;
        font-family: Arial, sans-serif;
    ">
        <div style="text-align: center;">
            <h1>âœ¨ Loading Delulu Diaries âœ¨</h1>
            <p>Checking authentication...</p>
        </div>
    </div>

    <!-- Main App Content (hidden initially) -->
    <div id="mainApp" style="display: none;">
        <!-- Header -->
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <h1 class="logo">Delulu Diaries âœ¨</h1>
                    <div class="header-actions">
                        <!-- User Profile -->
                        <div id="userProfile" class="user-profile">
                            <button id="profileBtn" class="profile-btn">
                                <img id="userPhoto" class="user-photo" src="" alt="User">
                                <span id="userName" class="user-name"></span>
                                <span class="profile-arrow">â–¼</span>
                            </button>
                            <div id="profileDropdown" class="profile-dropdown">
                                <div class="dropdown-header">
                                    <img id="dropdownUserPhoto" class="dropdown-photo" src="" alt="User">
                                    <div class="dropdown-info">
                                        <div id="dropdownUserName" class="dropdown-name"></div>
                                        <div id="dropdownUserEmail" class="dropdown-email"></div>
                                    </div>
                                </div>
                                <div class="dropdown-divider"></div>
                                <button id="logoutBtn" class="dropdown-item logout-btn">
                                    ðŸšª Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <!-- Mood Input Section -->
                <div class="mood-input-section">
                    <h2>What's your vibe today? ðŸŒˆ</h2>
                    <div class="mood-input-container">
                        <textarea id="moodInput" placeholder="Spill the tea bestie... what's your mood today? â˜•ï¸âœ¨" maxlength="500"></textarea>
                        <div class="input-footer">
                            <span class="char-counter">
                                <span id="charCount">0</span>/500
                            </span>
                            <button id="submitMood" class="submit-btn">Post Vibe âœ¨</button>
                        </div>
                    </div>
                    
                    <!-- Preset Mood Buttons -->
                    <div class="preset-moods">
                        <h3>Quick Vibes:</h3>
                        <div class="mood-buttons">
                            <button class="mood-btn" data-mood="âœ¨">âœ¨ Magical</button>
                            <button class="mood-btn" data-mood="ðŸ’–">ðŸ’– In Love</button>
                            <button class="mood-btn" data-mood="ðŸŽ­">ðŸŽ­ Dramatic</button>
                            <button class="mood-btn" data-mood="ðŸŒ™">ðŸŒ™ Mysterious</button>
                            <button class="mood-btn" data-mood="ðŸ¦‹">ðŸ¦‹ Dreamy</button>
                            <button class="mood-btn" data-mood="ðŸ‘‘">ðŸ‘‘ Main Character</button>
                        </div>
                    </div>
                </div>
                
                <!-- Mood Posts Section -->
                <div class="mood-posts-section">
                    <h2>Your Delulu Chronicles ðŸ“–</h2>
                    <div id="moodPosts" class="mood-posts">
                        <div class="no-posts">
                            No moods yet! Share your first vibe âœ¨
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    
    <!-- Simple Authentication Script -->
    <script>
        console.log('ðŸš€ Starting Delulu Diaries...');
        
        let currentUser = null;
        let authCheckComplete = false;
        
        // Wait for Firebase to load
        function waitForFirebase() {
            if (typeof firebase !== 'undefined' && firebase.auth) {
                console.log('ðŸ”¥ Firebase loaded');
                initializeAuth();
            } else {
                console.log('â³ Waiting for Firebase...');
                setTimeout(waitForFirebase, 100);
            }
        }
        
        function initializeAuth() {
            console.log('ðŸ” Setting up authentication...');
            
            // Set auth persistence
            firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                .then(() => {
                    console.log('âœ… Auth persistence set');
                    
                    // Listen for auth changes
                    firebase.auth().onAuthStateChanged((user) => {
                        console.log('ðŸ”„ Auth state changed:', user ? user.email : 'No user');
                        authCheckComplete = true;
                        
                        if (user) {
                            console.log('âœ… User authenticated:', user.email);
                            currentUser = user;
                            showMainApp();
                            setupApp();
                        } else {
                            console.log('âŒ No user, redirecting to login');
                            redirectToLogin();
                        }
                    });
                    
                    // Timeout fallback
                    setTimeout(() => {
                        if (!authCheckComplete) {
                            console.log('â° Auth check timeout, redirecting to login');
                            redirectToLogin();
                        }
                    }, 5000);
                })
                .catch((error) => {
                    console.error('âŒ Auth persistence error:', error);
                    redirectToLogin();
                });
        }
        
        function showMainApp() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
        }
        
        function redirectToLogin() {
            console.log('ðŸšª Redirecting to login...');
            window.location.href = 'login.html';
        }
        
        function setupApp() {
            console.log('ðŸŽ¨ Setting up app...');
            
            // Update profile
            if (currentUser) {
                document.getElementById('userPhoto').src = currentUser.photoURL || 'https://via.placeholder.com/32x32?text=ðŸ‘¤';
                document.getElementById('userName').textContent = currentUser.displayName || 'User';
                document.getElementById('dropdownUserPhoto').src = currentUser.photoURL || 'https://via.placeholder.com/60x60?text=ðŸ‘¤';
                document.getElementById('dropdownUserName').textContent = currentUser.displayName || 'User';
                document.getElementById('dropdownUserEmail').textContent = currentUser.email || '';
            }
            
            // Setup event listeners
            setupEventListeners();
            loadMoods();
        }
        
        function setupEventListeners() {
            // Profile dropdown
            document.getElementById('profileBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('profileDropdown').classList.toggle('show');
            });
            
            document.addEventListener('click', () => {
                document.getElementById('profileDropdown').classList.remove('show');
            });
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', () => {
                firebase.auth().signOut().then(() => {
                    localStorage.clear();
                    window.location.href = 'login.html';
                });
            });
            
            // Mood input
            const moodInput = document.getElementById('moodInput');
            const charCount = document.getElementById('charCount');
            
            moodInput.addEventListener('input', () => {
                charCount.textContent = moodInput.value.length;
            });
            
            // Submit mood
            document.getElementById('submitMood').addEventListener('click', submitMood);
            
            // Preset moods
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const mood = btn.dataset.mood;
                    moodInput.value = `Feeling ${mood} today! âœ¨`;
                    charCount.textContent = moodInput.value.length;
                });
            });
        }
        
        function submitMood() {
            const moodText = document.getElementById('moodInput').value.trim();
            if (!moodText) return;
            
            const moodData = {
                text: moodText,
                userId: currentUser.uid,
                userEmail: currentUser.email,
                userName: currentUser.displayName,
                userPhoto: currentUser.photoURL,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                createdAt: new Date()
            };
            
            firebase.firestore().collection('moods').add(moodData)
                .then(() => {
                    document.getElementById('moodInput').value = '';
                    document.getElementById('charCount').textContent = '0';
                    loadMoods();
                })
                .catch((error) => {
                    console.error('Error saving mood:', error);
                    alert('Failed to save mood. Please try again.');
                });
        }
        
        function loadMoods() {
            if (!currentUser) return;
            
            firebase.firestore()
                .collection('moods')
                .where('userId', '==', currentUser.uid)
                .orderBy('timestamp', 'desc')
                .limit(20)
                .get()
                .then((snapshot) => {
                    const moodPosts = document.getElementById('moodPosts');
                    moodPosts.innerHTML = '';
                    
                    if (snapshot.empty) {
                        moodPosts.innerHTML = '<div class="no-posts">No moods yet! Share your first vibe âœ¨</div>';
                        return;
                    }
                    
                    snapshot.forEach((doc) => {
                        const mood = doc.data();
                        const postDiv = document.createElement('div');
                        postDiv.className = 'mood-post';
                        
                        const date = mood.createdAt ? new Date(mood.createdAt.seconds * 1000) : new Date();
                        const timeStr = date.toLocaleString();
                        
                        postDiv.innerHTML = `
                            <div class="mood-text">${mood.text}</div>
                            <div class="mood-meta">Posted on ${timeStr}</div>
                        `;
                        
                        moodPosts.appendChild(postDiv);
                    });
                })
                .catch((error) => {
                    console.error('Error loading moods:', error);
                });
        }
        
        // Start the app
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ðŸ“± DOM loaded, starting app...');
            waitForFirebase();
        });
    </script>
</body>
</html>
